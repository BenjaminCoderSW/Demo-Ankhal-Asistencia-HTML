<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Producción - Sistema Ankhal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-box-seam"></i> ANKHAL - Sistema de Inventario
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear-fill"></i> Configuración
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="bases.html"><i class="bi bi-building"></i> Bases/Plantas</a></li>
                            <li><a class="dropdown-item" href="materiales.html"><i class="bi bi-box"></i> Materiales</a></li>
                            <li><a class="dropdown-item" href="productos.html"><i class="bi bi-grid-3x3-gap"></i> Productos</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-arrow-repeat"></i> Operaciones
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item active" href="produccion.html"><i class="bi bi-gear"></i> Producción</a></li>
                            <li><a class="dropdown-item" href="entregas.html"><i class="bi bi-truck"></i> Entregas</a></li>
                            <li><a class="dropdown-item" href="movimientos.html"><i class="bi bi-arrow-left-right"></i> Movimientos</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="inventario.html">
                            <i class="bi bi-clipboard-data"></i> Inventario
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-gear"></i> Control de Producción</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevaProduccion">
                        <i class="bi bi-plus-circle"></i> Registrar Producción
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs de Navegación -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabGeneral" type="button">
                    <i class="bi bi-graph-up"></i> Producción General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPorBase" type="button">
                    <i class="bi bi-building"></i> Producción por Base
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHistorial" type="button">
                    <i class="bi bi-clock-history"></i> Historial
                </button>
            </li>
        </ul>

        <!-- Contenido de Tabs -->
        <div class="tab-content">
            <!-- TAB: PRODUCCIÓN GENERAL -->
            <div class="tab-pane fade show active" id="tabGeneral">
                <!-- Métricas del Día -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h6 class="text-muted">PRODUCCIÓN HOY</h6>
                                <h2 class="text-primary">1,250</h2>
                                <p class="mb-1">total producido</p>
                                <ul class="list-unstyled text-start small mb-2">
                                    <li><i class="bi bi-box"></i> Tarimas: 680</li>
                                    <li><i class="bi bi-box2"></i> Cajas: 520</li>
                                    <li><i class="bi bi-tools"></i> Accesorios: 50</li>
                                </ul>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar bg-warning" style="width: 83%">83%</div>
                                </div>
                                <small class="text-muted">Meta: 1,500</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="text-muted">PRODUCTO BUENO</h6>
                                <h2 class="text-success">1,180</h2>
                                <p class="mb-1">(94.4%)</p>
                                <ul class="list-unstyled text-start small">
                                    <li>Tarimas: 640</li>
                                    <li>Cajas: 495</li>
                                    <li>Accesorios: 45</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h6 class="text-muted">PRODUCTO RECHAZO</h6>
                                <h2 class="text-danger">70</h2>
                                <p class="mb-1">(5.6%)</p>
                                <ul class="list-unstyled text-start small">
                                    <li>Tarimas: 40</li>
                                    <li>Cajas: 25</li>
                                    <li>Accesorios: 5</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h6 class="text-muted">MERMAS HOY</h6>
                                <h2 class="text-warning">85 pies</h2>
                                <p class="mb-1">madera</p>
                                <ul class="list-unstyled text-start small">
                                    <li>Madera Pino: 45 pies</li>
                                    <li>Madera Encino: 30 pies</li>
                                    <li>Cartón: 10 m²</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Producción de la Semana -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Producción Esta Semana (General)</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Día</th>
                                            <th>Producido</th>
                                            <th>Meta</th>
                                            <th>Cumplimiento</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>Lunes</td><td>1,420</td><td>1,500</td><td><span class="badge bg-success">95%</span></td></tr>
                                        <tr><td>Martes</td><td>1,580</td><td>1,500</td><td><span class="badge bg-success">105%</span></td></tr>
                                        <tr><td>Miércoles</td><td>1,350</td><td>1,500</td><td><span class="badge bg-warning">90%</span></td></tr>
                                        <tr><td>Jueves</td><td>1,480</td><td>1,500</td><td><span class="badge bg-success">99%</span></td></tr>
                                        <tr><td><strong>Viernes (Hoy)</strong></td><td><strong>1,250</strong></td><td><strong>1,500</strong></td><td><span class="badge bg-warning">83%</span></td></tr>
                                    </tbody>
                                    <tfoot class="table-secondary">
                                        <tr><td><strong>TOTAL</strong></td><td><strong>7,080</strong></td><td><strong>7,500</strong></td><td><span class="badge bg-success">94%</span></td></tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-tools"></i> Material Consumido Hoy</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Material</th>
                                            <th>Cantidad</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>Madera Pino 2x4</td><td>1,150 pies</td><td>$15,755</td></tr>
                                        <tr><td>Madera Encino 3x6</td><td>320 pies</td><td>$5,920</td></tr>
                                        <tr><td>Clavos 3"</td><td>14 kg</td><td>$490</td></tr>
                                        <tr><td>Arandelas M8</td><td>6 kg</td><td>$252</td></tr>
                                        <tr><td>Cartón RSC</td><td>85 m²</td><td>$7,225</td></tr>
                                    </tbody>
                                    <tfoot class="table-secondary">
                                        <tr><td colspan="2"><strong>TOTAL CONSUMIDO</strong></td><td><strong>$29,642</strong></td></tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: PRODUCCIÓN POR BASE -->
            <div class="tab-pane fade" id="tabPorBase">
                <h5 class="mb-3"><i class="bi bi-building"></i> Producción por Base (Esta Semana)</h5>
                <div class="row">
                    <!-- Base WEG -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Base WEG</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-4 text-center">
                                        <div class="card border-success">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Buenas</small>
                                                <h5 class="mb-0">2,340</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="card border-danger">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Rechazo</small>
                                                <h5 class="mb-0">120</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="card border-warning">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Mermas</small>
                                                <h5 class="mb-0">45 pies</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Producido</th>
                                            <th>Meta</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>Tarimas</td><td>1,520</td><td>1,600</td><td><span class="badge bg-success">95%</span></td></tr>
                                        <tr><td>Cajas</td><td>850</td><td>800</td><td><span class="badge bg-success">106%</span></td></tr>
                                        <tr><td>Accesorios</td><td>90</td><td>100</td><td><span class="badge bg-warning">90%</span></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Base TULA -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Base TULA</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-4 text-center">
                                        <div class="card border-success">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Buenas</small>
                                                <h5 class="mb-0">2,100</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="card border-danger">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Rechazo</small>
                                                <h5 class="mb-0">95</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="card border-warning">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Mermas</small>
                                                <h5 class="mb-0">38 pies</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Producido</th>
                                            <th>Meta</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>Tarimas</td><td>1,280</td><td>1,400</td><td><span class="badge bg-warning">91%</span></td></tr>
                                        <tr><td>Cajas</td><td>850</td><td>700</td><td><span class="badge bg-success">121%</span></td></tr>
                                        <tr><td>Accesorios</td><td>65</td><td>80</td><td><span class="badge bg-warning">81%</span></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Base QRO -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-warning">
                                <h6 class="mb-0">Base QRO</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-4 text-center">
                                        <div class="card border-success">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Buenas</small>
                                                <h5 class="mb-0">1,580</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="card border-danger">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Rechazo</small>
                                                <h5 class="mb-0">78</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="card border-warning">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Mermas</small>
                                                <h5 class="mb-0">22 pies</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Producido</th>
                                            <th>Meta</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>Tarimas</td><td>920</td><td>900</td><td><span class="badge bg-success">102%</span></td></tr>
                                        <tr><td>Cajas</td><td>690</td><td>650</td><td><span class="badge bg-success">106%</span></td></tr>
                                        <tr><td>Accesorios</td><td>48</td><td>50</td><td><span class="badge bg-success">96%</span></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen Total -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-secondary">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">RESUMEN TOTAL (Todas las bases)</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-4 text-center">
                                        <div class="card border-success">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Buenas</small>
                                                <h5 class="mb-0">6,020</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="card border-danger">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Rechazo</small>
                                                <h5 class="mb-0">293</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="card border-warning">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Mermas</small>
                                                <h5 class="mb-0">105 pies</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Producido</th>
                                            <th>Meta</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td><strong>Tarimas</strong></td><td><strong>3,720</strong></td><td><strong>3,900</strong></td><td><span class="badge bg-success">95%</span></td></tr>
                                        <tr><td><strong>Cajas</strong></td><td><strong>2,390</strong></td><td><strong>2,150</strong></td><td><span class="badge bg-success">111%</span></td></tr>
                                        <tr><td><strong>Accesorios</strong></td><td><strong>203</strong></td><td><strong>230</strong></td><td><span class="badge bg-warning">88%</span></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: HISTORIAL -->
            <div class="tab-pane fade" id="tabHistorial">
                <!-- Filtros de Búsqueda -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="filter-section">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label small">Rango de Fechas</label>
                                    <select class="form-select" id="rangoFecha">
                                        <option value="hoy">Hoy</option>
                                        <option value="semana" selected>Esta Semana</option>
                                        <option value="mes">Este Mes</option>
                                        <option value="personalizado">Personalizado</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Base</label>
                                    <select class="form-select" id="filtroBase">
                                        <option value="">Todas</option>
                                        <option value="TULA">TULA</option>
                                        <option value="WEG">WEG</option>
                                        <option value="ATOTO">ATOTO</option>
                                        <option value="ARKAM">ARKAM</option>
                                        <option value="QRO">QRO</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Producto</label>
                                    <select class="form-select" id="filtroProducto">
                                        <option value="">Todos</option>
                                        <option value="104">Tarima 104</option>
                                        <option value="125">Tarima 125</option>
                                        <option value="CAJA-RSC-01">Caja RSC-01</option>
                                    </select>
                                </div>
                                <div class="col-md-5 text-end">
                                    <label class="form-label small">&nbsp;</label><br>
                                    <button class="btn btn-primary">
                                        <i class="bi bi-search"></i> Buscar
                                    </button>
                                    <button class="btn btn-secondary">
                                        <i class="bi bi-x-circle"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Historial de Producción -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historial de Producción (Últimos registros)</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha/Hora</th>
                                                <th>Base</th>
                                                <th>Producto</th>
                                                <th>Cantidad Buena</th>
                                                <th>Rechazo</th>
                                                <th>Mermas</th>
                                                <th>Responsable</th>
                                                <th>Observaciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>16/01/2026 14:30</td>
                                                <td>WEG</td>
                                                <td>Tarima 104</td>
                                                <td><span class="badge bg-success">280 pzas</span></td>
                                                <td><span class="badge bg-danger">15 pzas</span></td>
                                                <td>25 pies madera</td>
                                                <td>Admin</td>
                                                <td>Turno tarde</td>
                                            </tr>
                                            <tr>
                                                <td>16/01/2026 08:00</td>
                                                <td>WEG</td>
                                                <td>Tarima 104</td>
                                                <td><span class="badge bg-success">320 pzas</span></td>
                                                <td><span class="badge bg-danger">8 pzas</span></td>
                                                <td>18 pies madera</td>
                                                <td>Admin</td>
                                                <td>Turno mañana</td>
                                            </tr>
                                            <tr>
                                                <td>16/01/2026 07:30</td>
                                                <td>TULA</td>
                                                <td>Caja RSC-01</td>
                                                <td><span class="badge bg-success">580 pzas</span></td>
                                                <td><span class="badge bg-danger">12 pzas</span></td>
                                                <td>8 m² cartón</td>
                                                <td>Admin</td>
                                                <td>-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer bg-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Mostrando 3 de 18 resultados</small>
                                    <nav>
                                        <ul class="pagination pagination-sm mb-0">
                                            <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                                            <li class="page-item"><a class="page-link" href="#">Siguiente</a></li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Producción -->
    <div class="modal fade" id="modalNuevaProduccion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Registrar Producción</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNuevaProduccion">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Base de Producción *</label>
                                <select class="form-select" id="baseProduccion" required>
                                    <option value="">Seleccione...</option>
                                    <option value="TULA">TULA</option>
                                    <option value="WEG">WEG</option>
                                    <option value="ATOTO">ATOTO</option>
                                    <option value="ARKAM">ARKAM</option>
                                    <option value="QRO">QRO</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Producto Fabricado *</label>
                                <select class="form-select" id="productoFabricado" required>
                                    <option value="">Seleccione...</option>
                                    <option value="104">Tarima 104 - Estándar 100x120</option>
                                    <option value="125">Tarima 125 - Industrial 120x120</option>
                                    <option value="CAJA-RSC-01">Caja RSC-01 - 40x30x30</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cantidad Buena *</label>
                                <input type="number" class="form-control" id="cantidadBuena" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cantidad Rechazo</label>
                                <input type="number" class="form-control" id="cantidadRechazo" value="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Meta Diaria</label>
                                <input type="number" class="form-control" id="metaDiaria" value="1500" readonly>
                            </div>
                        </div>

                        <!-- Sección Materiales Utilizados -->
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="bi bi-box-seam"></i> Materiales Utilizados</h6>
                            <span class="badge bg-info" id="badgeProductoSeleccionado">Seleccione un producto</span>
                        </div>

                        <div id="materialesUtilizadosContainer">
                            <div class="alert alert-secondary text-center" id="mensajeSinProducto">
                                <i class="bi bi-info-circle"></i> Seleccione un producto para ver los materiales requeridos
                            </div>

                            <div id="tablaMaterialesWrapper" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered" id="tablaMaterialesUtilizados">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Material</th>
                                                <th class="text-center" style="width: 140px;">Cant. Teórica</th>
                                                <th class="text-center" style="width: 120px;">Cant. Real</th>
                                                <th class="text-center" style="width: 90px;">Diferencia</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyMaterialesUtilizados">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="alert alert-warning small py-2 mb-3">
                                    <i class="bi bi-info-circle"></i>
                                    La cantidad teórica se multiplica por las unidades producidas (buena + rechazo).
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6>Mermas Generadas</h6>
                        <div id="mermasContainer">
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <select class="form-select" name="materialMerma[]">
                                        <option value="">Seleccionar material...</option>
                                        <option value="MAT-002">Madera Pino 2x4</option>
                                        <option value="MAT-006">Madera Encino 3x6</option>
                                        <option value="MAT-004">Cartón RSC</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="number" class="form-control" name="cantidadMerma[]" placeholder="Cantidad">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-sm btn-success w-100" onclick="agregarMerma()">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observacionesProd" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarProduccion()">
                        <i class="bi bi-save"></i> Registrar Producción
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Datos de productos con sus componentes de materiales
        const productosProduccion = [
            {
                codigo: '104',
                nombre: 'Tarima Estándar 100x120cm',
                componentes: [
                    { material: 'MAT-002', nombre: 'Madera Pino 2x4', cantidad: '20-30 piezas' },
                    { material: 'MAT-001', nombre: 'Clavos 3"', cantidad: '0.5-0.8 kg' },
                    { material: 'MAT-003', nombre: 'Arandelas M8', cantidad: '0.2-0.3 kg' }
                ]
            },
            {
                codigo: '125',
                nombre: 'Tarima Industrial 120x120cm',
                componentes: [
                    { material: 'MAT-002', nombre: 'Madera Pino 2x4', cantidad: '30-40 piezas' },
                    { material: 'MAT-006', nombre: 'Madera Encino 3x6', cantidad: '10-15 piezas' },
                    { material: 'MAT-001', nombre: 'Clavos 3"', cantidad: '0.8-1.2 kg' },
                    { material: 'MAT-003', nombre: 'Arandelas M8', cantidad: '0.3-0.5 kg' }
                ]
            },
            {
                codigo: 'CAJA-RSC-01',
                nombre: 'Caja RSC 40x30x30cm',
                componentes: [
                    { material: 'MAT-004', nombre: 'Cartón RSC', cantidad: '0.8-1.2 m²' },
                    { material: 'MAT-008', nombre: 'Adhesivo', cantidad: '0.05-0.1 litros' }
                ]
            }
        ];

        function obtenerProductoPorCodigo(codigo) {
            return productosProduccion.find(p => p.codigo === codigo);
        }

        function parsearRangoCantidad(rangoTexto) {
            const regex = /(\d+\.?\d*)\s*-\s*(\d+\.?\d*)\s*(\S+)/;
            const match = rangoTexto.match(regex);
            if (match) {
                return { min: parseFloat(match[1]), max: parseFloat(match[2]), unidad: match[3] };
            }
            const regexSimple = /(\d+\.?\d*)\s*(\S+)/;
            const matchSimple = rangoTexto.match(regexSimple);
            if (matchSimple) {
                return { min: parseFloat(matchSimple[1]), max: parseFloat(matchSimple[1]), unidad: matchSimple[2] };
            }
            return null;
        }

        function cargarMaterialesPorProducto(codigoProducto) {
            const mensajeSinProducto = document.getElementById('mensajeSinProducto');
            const tablaMaterialesWrapper = document.getElementById('tablaMaterialesWrapper');
            const tbody = document.getElementById('tbodyMaterialesUtilizados');
            const badge = document.getElementById('badgeProductoSeleccionado');

            if (!codigoProducto) {
                mensajeSinProducto.style.display = 'block';
                tablaMaterialesWrapper.style.display = 'none';
                badge.textContent = 'Seleccione un producto';
                badge.className = 'badge bg-info';
                return;
            }

            const producto = obtenerProductoPorCodigo(codigoProducto);

            if (!producto || !producto.componentes || producto.componentes.length === 0) {
                mensajeSinProducto.innerHTML = '<i class="bi bi-exclamation-circle"></i> Este producto no tiene componentes definidos';
                mensajeSinProducto.style.display = 'block';
                tablaMaterialesWrapper.style.display = 'none';
                return;
            }

            badge.textContent = producto.nombre;
            badge.className = 'badge bg-success';
            mensajeSinProducto.style.display = 'none';
            tablaMaterialesWrapper.style.display = 'block';

            tbody.innerHTML = '';
            producto.componentes.forEach((comp, index) => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>
                        <strong>${comp.nombre}</strong>
                        <input type="hidden" name="materialUtilizado[]" value="${comp.material}">
                        <br><small class="text-muted">${comp.material}</small>
                    </td>
                    <td class="text-center">
                        <span class="cantidad-teorica" data-rango="${comp.cantidad}" data-index="${index}">
                            ${comp.cantidad}
                        </span>
                        <br><small class="text-muted" id="cantidadCalculada_${index}">-</small>
                    </td>
                    <td>
                        <input type="number"
                               class="form-control form-control-sm text-center cantidad-real-input"
                               name="cantidadReal[]"
                               data-index="${index}"
                               step="0.01"
                               min="0"
                               placeholder="0.00"
                               onchange="calcularDiferencia(${index})">
                    </td>
                    <td class="text-center" id="diferencia_${index}">
                        <span class="badge bg-secondary">-</span>
                    </td>
                `;
                tbody.appendChild(fila);
            });

            recalcularCantidadesTeorica();
        }

        function recalcularCantidadesTeorica() {
            const cantidadBuena = parseInt(document.getElementById('cantidadBuena').value) || 0;
            const cantidadRechazo = parseInt(document.getElementById('cantidadRechazo').value) || 0;
            const cantidadTotal = cantidadBuena + cantidadRechazo;

            document.querySelectorAll('.cantidad-teorica').forEach(span => {
                const index = span.dataset.index;
                const rango = span.dataset.rango;
                const valores = parsearRangoCantidad(rango);

                if (cantidadTotal > 0 && valores) {
                    const minTotal = (valores.min * cantidadTotal).toFixed(2);
                    const maxTotal = (valores.max * cantidadTotal).toFixed(2);
                    document.getElementById(`cantidadCalculada_${index}`).textContent =
                        `${minTotal} - ${maxTotal} ${valores.unidad}`;
                } else {
                    document.getElementById(`cantidadCalculada_${index}`).textContent = '-';
                }

                calcularDiferencia(parseInt(index));
            });
        }

        function calcularDiferencia(index) {
            const inputReal = document.querySelector(`input[name="cantidadReal[]"][data-index="${index}"]`);
            if (!inputReal) return;

            const cantidadReal = parseFloat(inputReal.value) || 0;
            const spanTeorica = document.querySelector(`.cantidad-teorica[data-index="${index}"]`);
            if (!spanTeorica) return;

            const rango = spanTeorica.dataset.rango;
            const cantidadBuena = parseInt(document.getElementById('cantidadBuena').value) || 0;
            const cantidadRechazo = parseInt(document.getElementById('cantidadRechazo').value) || 0;
            const cantidadTotal = cantidadBuena + cantidadRechazo;
            const valores = parsearRangoCantidad(rango);
            const diferenciaEl = document.getElementById(`diferencia_${index}`);

            if (!valores || cantidadTotal === 0 || cantidadReal === 0) {
                diferenciaEl.innerHTML = '<span class="badge bg-secondary">-</span>';
                return;
            }

            const esperadoMin = valores.min * cantidadTotal;
            const esperadoMax = valores.max * cantidadTotal;
            const esperadoPromedio = (esperadoMin + esperadoMax) / 2;

            let diferencia = cantidadReal - esperadoPromedio;
            let badgeClass = 'bg-success';

            if (cantidadReal < esperadoMin) {
                badgeClass = 'bg-info';
            } else if (cantidadReal > esperadoMax) {
                badgeClass = 'bg-warning';
            }

            const signo = diferencia > 0 ? '+' : '';
            diferenciaEl.innerHTML = `<span class="badge ${badgeClass}">${signo}${diferencia.toFixed(2)}</span>`;
        }

        // Event listeners para actualización dinámica
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('productoFabricado').addEventListener('change', function() {
                cargarMaterialesPorProducto(this.value);
            });
            document.getElementById('cantidadBuena').addEventListener('input', recalcularCantidadesTeorica);
            document.getElementById('cantidadRechazo').addEventListener('input', recalcularCantidadesTeorica);
        });

        function agregarMerma() {
            const container = document.getElementById('mermasContainer');
            const nuevaMerma = document.createElement('div');
            nuevaMerma.className = 'row mb-2 merma-row';
            nuevaMerma.innerHTML = `
                <div class="col-md-6">
                    <select class="form-select" name="materialMerma[]">
                        <option value="">Seleccionar material...</option>
                        <option value="MAT-002">Madera Pino 2x4</option>
                        <option value="MAT-006">Madera Encino 3x6</option>
                        <option value="MAT-004">Cartón RSC</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control" name="cantidadMerma[]" placeholder="Cantidad">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-danger w-100" onclick="eliminarMerma(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(nuevaMerma);
        }

        function eliminarMerma(boton) {
            const row = boton.closest('.merma-row');
            row.remove();
        }

        function guardarProduccion() {
            const base = document.getElementById('baseProduccion').value;
            const producto = document.getElementById('productoFabricado').value;
            const cantidadBuena = document.getElementById('cantidadBuena').value;
            const cantidadRechazo = document.getElementById('cantidadRechazo').value || 0;
            const observaciones = document.getElementById('observacionesProd').value;

            if (!base || !producto || !cantidadBuena) {
                mostrarNotificacion('Complete todos los campos requeridos', 'error');
                return;
            }

            // Recopilar materiales utilizados
            const materialesUtilizados = [];
            const materialesInputs = document.querySelectorAll('input[name="materialUtilizado[]"]');
            const cantidadesReales = document.querySelectorAll('input[name="cantidadReal[]"]');

            materialesInputs.forEach((mat, index) => {
                const cantidadReal = parseFloat(cantidadesReales[index].value) || 0;
                materialesUtilizados.push({
                    material: mat.value,
                    cantidadReal: cantidadReal
                });
            });

            // Recopilar mermas
            const mermas = [];
            const mermasMateriales = document.querySelectorAll('select[name="materialMerma[]"]');
            const mermasCantidades = document.querySelectorAll('input[name="cantidadMerma[]"]');

            mermasMateriales.forEach((mat, index) => {
                if (mat.value && mermasCantidades[index].value) {
                    mermas.push({
                        material: mat.value,
                        cantidad: parseFloat(mermasCantidades[index].value)
                    });
                }
            });

            // Objeto de datos de producción (para visualización/debug)
            const datosProduccion = {
                fecha: new Date().toISOString(),
                base: base,
                producto: producto,
                cantidadBuena: parseInt(cantidadBuena),
                cantidadRechazo: parseInt(cantidadRechazo),
                materialesUtilizados: materialesUtilizados,
                mermas: mermas,
                observaciones: observaciones
            };

            console.log('Datos de Producción:', datosProduccion);

            mostrarNotificacion('Producción registrada exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevaProduccion'));
            modal.hide();

            // Limpiar sección de materiales
            document.getElementById('formNuevaProduccion').reset();
            document.getElementById('mensajeSinProducto').style.display = 'block';
            document.getElementById('tablaMaterialesWrapper').style.display = 'none';
            document.getElementById('badgeProductoSeleccionado').textContent = 'Seleccione un producto';
            document.getElementById('badgeProductoSeleccionado').className = 'badge bg-info';

            setTimeout(() => location.reload(), 1000);
        }
    </script>
</body>
</html>
