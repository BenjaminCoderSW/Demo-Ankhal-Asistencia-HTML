<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movimientos - Sistema Ankhal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-box-seam"></i> ANKHAL - Sistema de Inventario
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear-fill"></i> Configuración
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="bases.html"><i class="bi bi-building"></i> Bases/Plantas</a></li>
                            <li><a class="dropdown-item" href="materiales.html"><i class="bi bi-box"></i> Materiales</a></li>
                            <li><a class="dropdown-item" href="productos.html"><i class="bi bi-grid-3x3-gap"></i> Productos</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-arrow-repeat"></i> Operaciones
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="produccion.html"><i class="bi bi-gear"></i> Producción</a></li>
                            <li><a class="dropdown-item" href="entregas.html"><i class="bi bi-truck"></i> Entregas</a></li>
                            <li><a class="dropdown-item active" href="movimientos.html"><i class="bi bi-arrow-left-right"></i> Movimientos</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="inventario.html">
                            <i class="bi bi-clipboard-data"></i> Inventario
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-arrow-left-right"></i> Movimientos de Inventario</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoMovimiento">
                        <i class="bi bi-plus-circle"></i> Nuevo Movimiento
                    </button>
                </div>
            </div>
        </div>

        <!-- Resumen de movimientos hoy -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-success"><div class="card-body text-center">
                    <i class="bi bi-arrow-down-circle text-success" style="font-size: 2rem;"></i>
                    <h4 class="mt-2">5</h4><p class="mb-0">Entradas</p>
                </div></div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger"><div class="card-body text-center">
                    <i class="bi bi-arrow-up-circle text-danger" style="font-size: 2rem;"></i>
                    <h4 class="mt-2">8</h4><p class="mb-0">Salidas</p>
                </div></div>
            </div>
            <div class="col-md-3">
                <div class="card border-info"><div class="card-body text-center">
                    <i class="bi bi-arrow-left-right text-info" style="font-size: 2rem;"></i>
                    <h4 class="mt-2">3</h4><p class="mb-0">Transferencias</p>
                </div></div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning"><div class="card-body text-center">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                    <h4 class="mt-2">2</h4><p class="mb-0">Ajustes</p>
                </div></div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label small">Tipo Movimiento</label>
                            <select class="form-select" id="filtroTipoMov">
                                <option value="">Todos</option>
                                <option value="ENTRADA">Entrada</option>
                                <option value="SALIDA">Salida</option>
                                <option value="TRANSFERENCIA">Transferencia</option>
                                <option value="CONSUMO">Consumo Producción</option>
                                <option value="MERMA">Merma</option>
                                <option value="AJUSTE">Ajuste</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Base</label>
                            <select class="form-select" id="filtroBaseMov">
                                <option value="">Todas</option>
                                <option value="TULA">TULA</option>
                                <option value="WEG">WEG</option>
                                <option value="SM">SM</option>
                                <option value="ATOTO">ATOTO</option>
                                <option value="ARKAM">ARKAM</option>
                                <option value="QRO">QRO</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Fecha Desde</label>
                            <input type="date" class="form-control" id="fechaDesde">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Fecha Hasta</label>
                            <input type="date" class="form-control" id="fechaHasta">
                        </div>
                        <div class="col-md-4 text-end">
                            <label class="form-label small">&nbsp;</label><br>
                            <button class="btn btn-primary" onclick="filtrarMovimientos()">Filtrar</button>
                            <button class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de Movimientos -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header"><h5 class="mb-0">Historial de Movimientos (Últimos 30 días)</h5></div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha/Hora</th>
                                        <th>Tipo</th>
                                        <th>Base Origen</th>
                                        <th>Base Destino</th>
                                        <th>Material/Producto</th>
                                        <th>Cantidad</th>
                                        <th>Responsable</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>16/01/2026 14:30</td>
                                        <td><span class="badge bg-success">ENTRADA</span></td>
                                        <td>-</td>
                                        <td>TULA</td>
                                        <td>Madera Pino 2x4</td>
                                        <td>500 pies</td>
                                        <td>Admin</td>
                                        <td>Llegó del proveedor ABC</td>
                                    </tr>
                                    <tr>
                                        <td>16/01/2026 12:15</td>
                                        <td><span class="badge bg-danger">SALIDA</span></td>
                                        <td>WEG</td>
                                        <td>-</td>
                                        <td>Tarima 104</td>
                                        <td>50 pzas</td>
                                        <td>Francisco Gonzales</td>
                                        <td>Entrega a EMPRESA ABC</td>
                                    </tr>
                                    <tr>
                                        <td>16/01/2026 10:45</td>
                                        <td><span class="badge bg-info">TRANSFERENCIA</span></td>
                                        <td>SM</td>
                                        <td>QRO</td>
                                        <td>Cartón RSC</td>
                                        <td>100 m²</td>
                                        <td>Jose Armando</td>
                                        <td>Intercompañía</td>
                                    </tr>
                                    <tr>
                                        <td>16/01/2026 09:30</td>
                                        <td><span class="badge bg-warning">CONSUMO</span></td>
                                        <td>WEG</td>
                                        <td>-</td>
                                        <td>Madera Pino 2x4</td>
                                        <td>250 pies</td>
                                        <td>Admin</td>
                                        <td>Producción Tarima 104</td>
                                    </tr>
                                    <tr>
                                        <td>15/01/2026 16:20</td>
                                        <td><span class="badge bg-danger">MERMA</span></td>
                                        <td>WEG</td>
                                        <td>-</td>
                                        <td>Madera Encino 3x6</td>
                                        <td>25 pies</td>
                                        <td>Josefina Ortiz</td>
                                        <td>Merma en producción</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Mostrando 5 de 18 resultados</small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item"><a class="page-link" href="#">Siguiente</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Movimiento -->
<div class="modal fade" id="modalNuevoMovimiento" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Registrar Movimiento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevoMovimiento">
                    <div class="mb-3">
                        <label class="form-label">Tipo de Movimiento *</label>
                        <select class="form-select" id="tipoMovimiento" required onchange="ajustarFormularioMovimiento()">
                            <option value="">Seleccione...</option>
                            <option value="ENTRADA">Entrada (de proveedor)</option>
                            <option value="SALIDA">Salida (entrega a cliente)</option>
                            <option value="TRANSFERENCIA">Transferencia entre bases</option>
                            <option value="AJUSTE">Ajuste de inventario</option>
                        </select>
                    </div>

                    <!-- Base Origen (se oculta según tipo) -->
                    <div class="mb-3" id="baseOrigenRow">
                        <label class="form-label">Base Origen *</label>
                        <select class="form-select" id="baseOrigen">
                            <option value="">Seleccione...</option>
                            <option value="TULA">TULA</option>
                            <option value="WEG">WEG</option>
                            <option value="SM">SM</option>
                            <option value="ATOTO">ATOTO</option>
                            <option value="ARKAM">ARKAM</option>
                            <option value="QRO">QRO</option>
                        </select>
                        <small class="text-muted" id="origenHelp"></small>
                    </div>

                    <!-- Base Destino (se oculta según tipo) -->
                    <div class="mb-3" id="baseDestinoRow" style="display:none;">
                        <label class="form-label">Base Destino *</label>
                        <select class="form-select" id="baseDestino">
                            <option value="">Seleccione...</option>
                            <option value="TULA">TULA</option>
                            <option value="WEG">WEG</option>
                            <option value="SM">SM</option>
                            <option value="ATOTO">ATOTO</option>
                            <option value="ARKAM">ARKAM</option>
                            <option value="QRO">QRO</option>
                        </select>
                        <small class="text-muted" id="destinoHelp"></small>
                    </div>

                    <!-- Items simples (para movimientos de un solo item) -->
                    <div id="itemSimple">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Material/Producto *</label>
                                <select class="form-select" id="item" required>
                                    <option value="">Seleccione...</option>
                                    <option value="MAT-002">Madera Pino 2x4</option>
                                    <option value="MAT-006">Madera Encino 3x6</option>
                                    <option value="MAT-001">Clavos 3"</option>
                                    <option value="104">Tarima 104</option>
                                    <option value="125">Tarima 125</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cantidad *</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="cantidad" required>
                                    <span class="input-group-text">unidad</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items múltiples (para transferencias) -->
                    <div id="itemsMultiples" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Materiales/Productos a transferir *</label>
                            <button type="button" class="btn btn-success btn-sm" onclick="agregarItemTransferencia()">
                                <i class="bi bi-plus-circle"></i> Agregar otro
                            </button>
                        </div>
                        <div id="listaItemsTransferencia">
                            <!-- Aquí se agregan dinámicamente los items -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observaciones" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarMovimiento()">
                    <i class="bi bi-save"></i> Registrar Movimiento
                </button>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        function ajustarFormulario() {
            const tipo = document.getElementById('tipoMovimiento').value;
            const baseDestinoRow = document.getElementById('baseDestinoRow');
            baseDestinoRow.style.display = tipo === 'TRANSFERENCIA' ? 'block' : 'none';
        }
        
        function guardarMovimiento() {
            const tipo = document.getElementById('tipoMovimiento').value;
            const baseOrigen = document.getElementById('baseOrigen').value;
            const item = document.getElementById('item').value;
            const cantidad = document.getElementById('cantidad').value;
            
            if (!tipo || !baseOrigen || !item || !cantidad) {
                mostrarNotificacion('Complete todos los campos requeridos', 'error');
                return;
            }
            
            mostrarNotificacion('Movimiento registrado exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoMovimiento'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        }
        
        function filtrarMovimientos() {
            mostrarNotificacion('Aplicando filtros...', 'info');
        }
    </script>
    <script>
    let contadorItemsTransferencia = 0;

    function ajustarFormularioMovimiento() {
        const tipo = document.getElementById('tipoMovimiento').value;
        const origenRow = document.getElementById('baseOrigenRow');
        const destinoRow = document.getElementById('baseDestinoRow');
        const origenSelect = document.getElementById('baseOrigen');
        const destinoSelect = document.getElementById('baseDestino');
        const origenHelp = document.getElementById('origenHelp');
        const destinoHelp = document.getElementById('destinoHelp');
        const itemSimple = document.getElementById('itemSimple');
        const itemsMultiples = document.getElementById('itemsMultiples');

        // Reset
        origenRow.style.display = 'none';
        destinoRow.style.display = 'none';
        origenSelect.required = false;
        destinoSelect.required = false;
        origenHelp.textContent = '';
        destinoHelp.textContent = '';

        // Reset items
        itemSimple.style.display = 'block';
        itemsMultiples.style.display = 'none';
        document.getElementById('item').required = true;
        document.getElementById('cantidad').required = true;

        switch(tipo) {
            case 'ENTRADA':
                // Solo destino
                destinoRow.style.display = 'block';
                destinoSelect.required = true;
                destinoHelp.textContent = 'Base donde llegará el material del proveedor';
                break;

            case 'SALIDA':
                // Solo origen
                origenRow.style.display = 'block';
                origenSelect.required = true;
                origenHelp.textContent = 'Base desde donde sale la entrega al cliente';
                break;

            case 'TRANSFERENCIA':
                // Ambos
                origenRow.style.display = 'block';
                destinoRow.style.display = 'block';
                origenSelect.required = true;
                destinoSelect.required = true;
                origenHelp.textContent = 'Base desde donde sale el material';
                destinoHelp.textContent = 'Base a donde llega el material';

                // Mostrar items múltiples
                itemSimple.style.display = 'none';
                itemsMultiples.style.display = 'block';
                document.getElementById('item').required = false;
                document.getElementById('cantidad').required = false;

                // Limpiar y agregar primer item
                document.getElementById('listaItemsTransferencia').innerHTML = '';
                contadorItemsTransferencia = 0;
                agregarItemTransferencia();
                break;

            case 'CONSUMO':
            case 'MERMA':
            case 'AJUSTE':
                // Solo origen
                origenRow.style.display = 'block';
                origenSelect.required = true;
                origenHelp.textContent = tipo === 'CONSUMO' ? 'Base donde se usó en producción' :
                                         tipo === 'MERMA' ? 'Base donde ocurrió la merma' :
                                         'Base donde se hace el ajuste';
                break;
        }
    }

    function agregarItemTransferencia() {
        contadorItemsTransferencia++;
        const lista = document.getElementById('listaItemsTransferencia');
        const itemId = contadorItemsTransferencia;

        const itemHTML = `
            <div class="card mb-2" id="itemTransferencia_${itemId}">
                <div class="card-body py-2 px-3">
                    <div class="row align-items-center">
                        <div class="col-md-5">
                            <select class="form-select form-select-sm item-transferencia" required>
                                <option value="">Seleccione material/producto...</option>
                                <option value="MAT-002">Madera Pino 2x4</option>
                                <option value="MAT-006">Madera Encino 3x6</option>
                                <option value="MAT-001">Clavos 3"</option>
                                <option value="104">Tarima 104</option>
                                <option value="125">Tarima 125</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control cantidad-transferencia" placeholder="Cantidad" required>
                                <span class="input-group-text">unidad</span>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarItemTransferencia(${itemId})" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        lista.insertAdjacentHTML('beforeend', itemHTML);
    }

    function eliminarItemTransferencia(id) {
        const item = document.getElementById(`itemTransferencia_${id}`);
        if (item) {
            // Verificar que quede al menos un item
            const items = document.querySelectorAll('#listaItemsTransferencia .card');
            if (items.length > 1) {
                item.remove();
            } else {
                mostrarNotificacion('Debe haber al menos un material en la transferencia', 'warning');
            }
        }
    }
    
    function guardarMovimiento() {
        const tipo = document.getElementById('tipoMovimiento').value;
        const baseOrigen = document.getElementById('baseOrigen').value;
        const baseDestino = document.getElementById('baseDestino').value;

        if (!tipo) {
            mostrarNotificacion('Seleccione el tipo de movimiento', 'error');
            return;
        }

        // Validar según tipo
        if ((tipo === 'SALIDA' || tipo === 'CONSUMO' || tipo === 'MERMA' || tipo === 'AJUSTE') && !baseOrigen) {
            mostrarNotificacion('Debe seleccionar la base de origen', 'error');
            return;
        }

        if (tipo === 'ENTRADA' && !baseDestino) {
            mostrarNotificacion('Debe seleccionar la base de destino', 'error');
            return;
        }

        if (tipo === 'TRANSFERENCIA') {
            if (!baseOrigen || !baseDestino) {
                mostrarNotificacion('Debe seleccionar origen y destino', 'error');
                return;
            }

            if (baseOrigen === baseDestino) {
                mostrarNotificacion('El origen y destino no pueden ser iguales', 'error');
                return;
            }

            // Validar items múltiples
            const itemsSelect = document.querySelectorAll('#listaItemsTransferencia .item-transferencia');
            const cantidadesInput = document.querySelectorAll('#listaItemsTransferencia .cantidad-transferencia');

            let todosValidos = true;
            itemsSelect.forEach((select, index) => {
                if (!select.value || !cantidadesInput[index].value || cantidadesInput[index].value <= 0) {
                    todosValidos = false;
                }
            });

            if (!todosValidos) {
                mostrarNotificacion('Complete todos los materiales y cantidades de la transferencia', 'error');
                return;
            }
        } else {
            // Validar item simple
            const item = document.getElementById('item').value;
            const cantidad = document.getElementById('cantidad').value;

            if (!item || !cantidad) {
                mostrarNotificacion('Complete todos los campos requeridos', 'error');
                return;
            }
        }

        mostrarNotificacion('Movimiento registrado exitosamente', 'success');
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoMovimiento'));
        modal.hide();
        setTimeout(() => location.reload(), 1000);
    }
    
    function filtrarMovimientos() {
        mostrarNotificacion('Aplicando filtros...', 'info');
    }
</script>
</body>
</html>
